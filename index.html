<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BotHostify - Host Your Scripts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { background-color: #111827; color: #d1d5db; }
        .modal-bg { background-color: rgba(0, 0, 0, 0.7); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .status-running { background-color: #22c55e; /* green-500 */ }
        .status-stopped { background-color: #ef4444; /* red-500 */ }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid #3b82f6; /* blue-500 */ width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Styles for AI-generated Markdown content */
        .markdown-content h1, .markdown-content h2 { font-size: 1.25em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; border-bottom: 1px solid #4b5563; padding-bottom: 0.25em; }
        .markdown-content p { margin-bottom: 1em; }
        .markdown-content code { background-color: #374151; padding: 0.2em 0.4em; border-radius: 3px; font-family: monospace; }
        .markdown-content pre { background-color: #1f2937; padding: 1em; border-radius: 5px; overflow-x: auto; margin-bottom: 1em; }
        .markdown-content pre code { padding: 0; background-color: transparent; }
        .markdown-content ul { list-style-type: disc; margin-left: 1.5em; margin-bottom: 1em; }
        .markdown-content blockquote { border-left: 4px solid #4b5563; padding-left: 1em; color: #9ca3af; margin-bottom: 1em; }
    </style>
</head>
<body class="font-sans">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="spinner mx-auto"></div>
            <p id="loading-text" class="mt-4 text-white">Connecting to backend...</p>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white">Bot<span class="text-blue-500">Hostify</span></h1>
            <p class="text-gray-400 mt-2">The simplest way to host your Python & Node.js scripts.</p>
        </header>

        <section id="user-info" class="mb-6 p-4 bg-gray-800 rounded-lg flex items-center justify-between">
            <div>
                <span class="text-sm text-gray-400">Your User ID:</span>
                <span id="user-id-display" class="font-mono text-sm bg-gray-700 text-blue-400 px-2 py-1 rounded">Loading...</span>
            </div>
            <button id="refresh-scripts-btn" class="text-blue-400 hover:text-blue-300 transition-colors">&#x21bb; Refresh</button>
        </section>

        <section id="upload-section" class="mb-8">
            <h2 class="text-2xl font-semibold text-white mb-4">Upload Your Scripts</h2>
            <div class="bg-gray-800 p-6 rounded-lg text-center">
                <p class="mb-4">Upload .py, .js, or .zip files. ZIP archives will be automatically extracted.</p>
                <input type="hidden" role="uploadcare-uploader" />
            </div>
        </section>

        <section id="dashboard">
            <h2 class="text-2xl font-semibold text-white mb-4">My Scripts</h2>
            <div id="scripts-list" class="space-y-4">
                <!-- Scripts will be dynamically inserted here -->
            </div>
        </section>

    </div>

    <!-- Log Viewer Modal -->
    <div id="log-modal" class="fixed inset-0 modal-bg items-center justify-center z-40 hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-4xl h-5/6 flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-semibold text-white">Logs for <span id="log-filename" class="font-mono"></span></h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            <div class="p-4 flex-grow overflow-y-auto">
                <button id="analyze-logs-btn" class="w-full mb-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors flex items-center justify-center disabled:opacity-50">
                    <span id="analyze-btn-text">✨ Analyze Logs with AI</span>
                    <div id="analyze-spinner" class="spinner !w-5 !h-5 ml-3 hidden"></div>
                </button>
                <div id="ai-analysis-container" class="mb-4 hidden">
                    <h4 class="text-lg font-semibold text-blue-400 mb-2">AI Analysis:</h4>
                    <div id="ai-analysis-content" class="p-4 bg-gray-900 rounded markdown-content"></div>
                </div>
                <pre id="log-content" class="w-full h-full bg-gray-900 text-sm text-gray-300 p-4 rounded font-mono whitespace-pre-wrap break-words"></pre>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notification" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- 1. CONFIGURATION ---
        // Enter your confirmed, working credentials here.
        const CONFIG = {
            BACKEND_URL: 'https://your-app-name.onrender.com', // <-- PASTE YOUR RENDER URL HERE
            API_KEY: 'change-this-to-your-own-secret-key',      // <-- PASTE YOUR SECRET API KEY HERE
            LOG_REFRESH_INTERVAL: 5000,
            UPLOADCARE_PUBLIC_KEY: '6f870073f3f09eab3217'
        };

        // --- 2. STATE & DOM ELEMENTS ---
        let state = {
            userId: null,
            logPollingInterval: null,
        };

        const DOMElements = {
            loadingOverlay: document.getElementById('loading-overlay'),
            loadingText: document.getElementById('loading-text'),
            userIdDisplay: document.getElementById('user-id-display'),
            scriptsList: document.getElementById('scripts-list'),
            refreshBtn: document.getElementById('refresh-scripts-btn'),
            uploaderInput: document.querySelector('[role=uploadcare-uploader]'),
            logModal: {
                container: document.getElementById('log-modal'),
                closeBtn: document.getElementById('close-modal-btn'),
                filename: document.getElementById('log-filename'),
                content: document.getElementById('log-content'),
                analyzeBtn: document.getElementById('analyze-logs-btn'),
                aiContainer: document.getElementById('ai-analysis-container'),
                aiContent: document.getElementById('ai-analysis-content'),
            },
            notification: document.getElementById('notification'),
        };

        // --- 3. API HELPER ---
        const api = {
            async request(endpoint, options = {}) {
                const url = `${CONFIG.BACKEND_URL}${endpoint}`;
                const headers = { 'Content-Type': 'application/json', 'X-Api-Key': CONFIG.API_KEY };
                try {
                    const response = await fetch(url, { ...options, headers });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: `HTTP error! Status: ${response.status}` }));
                        throw new Error(errorData.error || `HTTP ${response.status}`);
                    }
                    // Handle cases where backend sends no JSON body on success (e.g., 204 No Content)
                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                        return response.json();
                    }
                    return {}; // Return empty object for non-json success responses
                } catch (error) {
                    showNotification(`API Error: ${error.message}`, 'error');
                    console.error('API request failed:', error);
                    throw error;
                }
            },
            register: () => api.request('/api/register', { method: 'POST' }),
            upload: (userId, files) => api.request(`/api/upload/${userId}`, { method: 'POST', body: JSON.stringify({ files }) }),
            getScripts: (userId) => api.request(`/api/scripts/${userId}`),
            startScript: (userId, filename) => api.request(`/api/scripts/${userId}/${filename}/start`, { method: 'POST' }),
            stopScript: (userId, filename) => api.request(`/api/scripts/${userId}/${filename}/stop`, { method: 'POST' }),
            deleteScript: (userId, filename) => api.request(`/api/scripts/${userId}/${filename}`, { method: 'DELETE' }),
            getLogs: (userId, filename) => api.request(`/api/logs/${userId}/${filename}`),
            analyzeLogs: (userId, filename) => api.request(`/api/logs/${userId}/${filename}/analyze`, { method: 'POST' }),
        };

        // --- 4. CORE APPLICATION LOGIC ---
        const initializeApp = async () => {
            DOMElements.loadingText.textContent = 'Connecting to backend...';
            DOMElements.loadingOverlay.style.display = 'flex';

            try {
                let userId = localStorage.getItem('botHostifyUserId');
                if (!userId) {
                    DOMElements.loadingText.textContent = 'Registering new user...';
                    const data = await api.register();
                    userId = data.user_id;
                    localStorage.setItem('botHostifyUserId', userId);
                }
                state.userId = userId;
                DOMElements.userIdDisplay.textContent = userId;

                DOMElements.loadingText.textContent = 'Loading your scripts...';
                await fetchAndRenderScripts();
                
                initializeUploadWidget();

            } catch (error) {
                DOMElements.loadingText.textContent = 'Connection Failed. Please refresh.';
                DOMElements.userIdDisplay.textContent = 'Error';
                DOMElements.scriptsList.innerHTML = `<p class="text-red-400 text-center">Could not connect to the backend. Please ensure the URL is correct and the service is running.</p>`;
                return; // Stop execution
            } finally {
                // This block GUARANTEES the loading screen will be hidden
                DOMElements.loadingOverlay.style.display = 'none';
            }
        };

        const fetchAndRenderScripts = async () => {
            if (!state.userId) return;
            try {
                const scripts = await api.getScripts(state.userId);
                renderScripts(scripts);
            } catch (error) {
                 DOMElements.scriptsList.innerHTML = `<p class="text-yellow-400 text-center">Could not load scripts. Please try refreshing the page.</p>`;
            }
        };

        const renderScripts = (scripts) => {
            DOMElements.scriptsList.innerHTML = '';
            if (!scripts || scripts.length === 0) {
                DOMElements.scriptsList.innerHTML = '<p class="text-gray-500 text-center">No scripts found. Upload one to get started!</p>';
                return;
            }
            scripts.forEach(script => {
                const isRunning = script.status === 'running';
                const scriptElement = document.createElement('div');
                scriptElement.className = 'bg-gray-800 p-4 rounded-lg flex items-center justify-between flex-wrap gap-2';
                scriptElement.innerHTML = `
                    <div class="flex items-center">
                        <span class="status-dot ${isRunning ? 'status-running' : 'status-stopped'}"></span>
                        <span class="font-mono text-white break-all">${script.name}</span>
                    </div>
                    <div class="flex items-center space-x-2 flex-shrink-0">
                        <button class="toggle-run-btn px-3 py-1 text-sm rounded transition-colors ${isRunning ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'}" data-filename="${script.name}">
                           <span class="btn-text">${isRunning ? 'Stop' : 'Start'}</span>
                           <div class="spinner !w-4 !h-4 hidden"></div>
                        </button>
                        <button class="view-logs-btn px-3 py-1 text-sm bg-gray-600 hover:bg-gray-700 rounded" data-filename="${script.name}">Logs</button>
                        <button class="delete-btn px-3 py-1 text-sm bg-red-800 hover:bg-red-900 rounded" data-filename="${script.name}">Delete</button>
                    </div>
                `;
                DOMElements.scriptsList.appendChild(scriptElement);
            });
        };
        
        const initializeUploadWidget = () => {
            DOMElements.uploaderInput.setAttribute('data-public-key', CONFIG.UPLOADCARE_PUBLIC_KEY);
            DOMElements.uploaderInput.setAttribute('data-multiple', 'true');
            DOMElements.uploaderInput.setAttribute('data-multiple-max', '7');
            DOMElements.uploaderInput.setAttribute('data-tabs', 'file url');

            const widget = uploadcare.Widget(DOMElements.uploaderInput);
            widget.onUploadComplete(async (groupInfo) => {
                DOMElements.loadingOverlay.style.display = 'flex';
                DOMElements.loadingText.textContent = 'Processing uploaded files...';
                try {
                    const fileUuids = groupInfo.files().map(file => file.uuid);
                    await api.upload(state.userId, fileUuids);
                    showNotification('Files uploaded successfully!', 'success');
                    await fetchAndRenderScripts();
                } finally {
                    DOMElements.loadingOverlay.style.display = 'none';
                }
            });
        };
        
        // --- 5. EVENT HANDLERS & UI HELPERS ---
        DOMElements.refreshBtn.addEventListener('click', fetchAndRenderScripts);

        DOMElements.scriptsList.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const filename = button.dataset.filename;

            if (button.classList.contains('toggle-run-btn')) {
                const btnText = button.querySelector('.btn-text');
                const spinner = button.querySelector('.spinner');
                const isRunning = btnText.textContent === 'Stop';
                
                btnText.classList.add('hidden');
                spinner.classList.remove('hidden');
                button.disabled = true;

                try {
                    if (isRunning) {
                        await api.stopScript(state.userId, filename);
                        showNotification(`Stopped ${filename}`, 'success');
                    } else {
                        await api.startScript(state.userId, filename);
                        showNotification(`Started ${filename}`, 'success');
                    }
                    await fetchAndRenderScripts();
                } catch (error) {
                    // Re-enable button on failure
                    btnText.classList.remove('hidden');
                    spinner.classList.add('hidden');
                    button.disabled = false;
                }
            } else if (button.classList.contains('view-logs-btn')) {
                openLogModal(filename);
            } else if (button.classList.contains('delete-btn')) {
                if (confirm(`Are you sure you want to delete ${filename}? This action cannot be undone.`)) {
                    DOMElements.loadingOverlay.style.display = 'flex';
                    try {
                        await api.deleteScript(state.userId, filename);
                        showNotification(`${filename} deleted successfully.`, 'success');
                        await fetchAndRenderScripts();
                    } finally {
                        DOMElements.loadingOverlay.style.display = 'none';
                    }
                }
            }
        });

        // Log Modal Logic
        const openLogModal = async (filename) => {
            const modal = DOMElements.logModal;
            modal.filename.textContent = filename;
            modal.content.textContent = 'Loading logs...';
            modal.aiContainer.classList.add('hidden');
            modal.aiContent.innerHTML = '';
            modal.container.classList.remove('hidden');
            modal.container.classList.add('flex');

            const fetchLogs = async () => {
                const data = await api.getLogs(state.userId, filename);
                modal.content.textContent = data.logs || '(No log output)';
            };

            await fetchLogs();
            state.logPollingInterval = setInterval(fetchLogs, CONFIG.LOG_REFRESH_INTERVAL);

            // Re-bind analyze button listener to prevent multiple triggers
            const analyzeBtn = modal.analyzeBtn;
            const analyzeBtnClone = analyzeBtn.cloneNode(true);
            analyzeBtn.parentNode.replaceChild(analyzeBtnClone, analyzeBtn);
            
            analyzeBtnClone.addEventListener('click', async () => {
                const textSpan = analyzeBtnClone.querySelector('#analyze-btn-text');
                const spinner = analyzeBtnClone.querySelector('#analyze-spinner');
                textSpan.textContent = 'Analyzing...';
                spinner.classList.remove('hidden');
                analyzeBtnClone.disabled = true;
                try {
                    const result = await api.analyzeLogs(state.userId, filename);
                    modal.aiContent.innerHTML = marked.parse(result.analysis);
                    modal.aiContainer.classList.remove('hidden');
                } finally {
                    textSpan.textContent = '✨ Analyze Logs with AI';
                    spinner.classList.add('hidden');
                    analyzeBtnClone.disabled = false;
                }
            });
        };

        const closeLogModal = () => {
            DOMElements.logModal.container.classList.add('hidden');
            DOMElements.logModal.container.classList.remove('flex');
            clearInterval(state.logPollingInterval);
        };

        DOMElements.logModal.closeBtn.addEventListener('click', closeLogModal);
        DOMElements.logModal.container.addEventListener('click', (e) => {
            if (e.target === DOMElements.logModal.container) closeLogModal();
        });

        const showNotification = (message, type = 'success') => {
            const el = DOMElements.notification;
            el.textContent = message;
            el.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transform transition-all duration-300 ${type === 'error' ? 'bg-red-600' : 'bg-green-600'}`;
            el.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                el.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        };
        
        // --- 6. START THE APP ---
        initializeApp();
    });
    </script>
</body>
</html>

