<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BotHostify - Host Your Scripts</title>
    
    <!-- ================== UPLOADCARE CONFIGURATION (THE FIX) ================== -->
    <!-- 1. The Public Key MUST be defined here, BEFORE the library is loaded. -->
    <script>
        UPLOADCARE_PUBLIC_KEY = '6f870073f3f09eab3217';
    </script>

    <!-- 2. Now, load the library. It will find the key defined above. -->
    <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>
    <!-- ======================================================================= -->

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { background-color: #111827; color: #d1d5db; }
        .modal-bg { background-color: rgba(0, 0, 0, 0.7); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .status-running { background-color: #22c55e; /* green-500 */ }
        .status-stopped { background-color: #ef4444; /* red-500 */ }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid #3b82f6; /* blue-500 */ width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .markdown-content h1, .markdown-content h2 { font-size: 1.25em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; border-bottom: 1px solid #4b5563; padding-bottom: 0.25em; }
        .markdown-content p { margin-bottom: 1em; }
        .markdown-content code { background-color: #374151; padding: 0.2em 0.4em; border-radius: 3px; font-family: monospace; }
        .markdown-content pre { background-color: #1f2937; padding: 1em; border-radius: 5px; overflow-x: auto; margin-bottom: 1em; }
        .markdown-content pre code { padding: 0; background-color: transparent; }
        .markdown-content ul { list-style-type: disc; margin-left: 1.5em; margin-bottom: 1em; }
        .markdown-content blockquote { border-left: 4px solid #4b5563; padding-left: 1em; color: #9ca3af; margin-bottom: 1em; }
    </style>
</head>
<body class="font-sans">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="spinner mx-auto"></div>
            <p id="loading-text" class="mt-4 text-white">Connecting to backend...</p>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white">Bot<span class="text-blue-500">Hostify</span></h1>
            <p class="text-gray-400 mt-2">The simplest way to host your Python & Node.js scripts.</p>
        </header>
         <section id="login-section" class="mb-8">
            <div class="bg-gray-800 p-6 rounded-lg text-center">
                <h2 class="text-2xl font-semibold text-white mb-4">Login or Register</h2>
                <p class="mb-4">Enter your email to manage your scripts.</p>
                <form id="login-form" class="flex justify-center">
                    <input type="email" id="email-input" placeholder="your@email.com" required class="bg-gray-700 text-white px-4 py-2 rounded-l-md focus:outline-none w-64">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-r-md">Login</button>
                </form>
            </div>
         </section>
        <section id="user-info" class="mb-6 p-4 bg-gray-800 rounded-lg flex items-center justify-between">
            <div>
                <span class="text-sm text-gray-400">Your User ID:</span>
                <span id="user-id-display" class="font-mono text-sm bg-gray-700 text-blue-400 px-2 py-1 rounded">Loading...</span>
            </div>
            <button id="refresh-scripts-btn" class="text-blue-400 hover:text-blue-300 transition-colors">&#x21bb; Refresh</button>
        </section>

        <section id="upload-section" class="mb-8">
            <h2 class="text-2xl font-semibold text-white mb-4">Upload Your Scripts</h2>
            <div class="bg-gray-800 p-6 rounded-lg text-center">
                <p class="mb-4">Upload .py, .js, or .zip files. ZIP archives will be automatically extracted.</p>
                <!-- This input is now automatically configured by the global key -->
                <input type="hidden" role="uploadcare-uploader" data-multiple="true" data-multiple-max="7" data-tabs="file url" />
            </div>
        </section>

        <section id="dashboard">
            <h2 class="text-2xl font-semibold text-white mb-4">My Scripts</h2>
            <div id="scripts-list" class="space-y-4">
                <!-- Scripts will be dynamically inserted here -->
            </div>
        </section>

    </div>

    <!-- Log Viewer Modal -->
    <div id="log-modal" class="fixed inset-0 modal-bg items-center justify-center z-40 hidden">
         <!-- Modal content is unchanged -->
         <div class="bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-4xl h-5/6 flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-semibold text-white">Logs for <span id="log-filename" class="font-mono"></span></h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            <div class="p-4 flex-grow overflow-y-auto">
                <button id="analyze-logs-btn" class="w-full mb-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors flex items-center justify-center disabled:opacity-50">
                    <span id="analyze-btn-text">âœ¨ Analyze Logs with AI</span>
                    <div id="analyze-spinner" class="spinner !w-5 !h-5 ml-3 hidden"></div>
                </button>
                <div id="ai-analysis-container" class="mb-4 hidden">
                    <h4 class="text-lg font-semibold text-blue-400 mb-2">AI Analysis:</h4>
                    <div id="ai-analysis-content" class="p-4 bg-gray-900 rounded markdown-content"></div>
                </div>
                <pre id="log-content" class="w-full h-full bg-gray-900 text-sm text-gray-300 p-4 rounded font-mono whitespace-pre-wrap break-words"></pre>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notification" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300"></div>
<script>
    document.addEventListener('DOMContentLoaded', () => {

        const CONFIG = {
            BACKEND_URL: 'https://1fdf10bbadfa8b.lhr.life', // Your backend URL
            API_KEY: 'change-this-to-your-own-secret-key',
        };
        
        // --- STATE MANAGEMENT ---
        let state = {
            email: null 
        };

        // --- DOM ELEMENTS ---
        const DOMElements = {
            loginSection: document.getElementById('login-section'),
            loginForm: document.getElementById('login-form'),
            emailInput: document.getElementById('email-input'),
            dashboard: document.getElementById('dashboard'),
            scriptsList: document.getElementById('scripts-list'),
            notification: document.getElementById('notification'),
            // Add other elements if they are outside the new dashboard scope
            uploadSection: document.getElementById('upload-section') 
        };

        // --- API HELPER ---
        const api = {
            async request(endpoint, options = {}) {
                const url = `${CONFIG.BACKEND_URL}${endpoint}`;
                const headers = { 'Content-Type': 'application/json', 'X-Api-Key': CONFIG.API_KEY };
                try {
                    const response = await fetch(url, { ...options, headers });
                    const responseData = await response.json();
                    if (!response.ok) {
                        throw new Error(responseData.error || `HTTP error! Status: ${response.status}`);
                    }
                    return responseData;
                } catch (error) {
                    showNotification(`API Error: ${error.message}`, 'error');
                    console.error('API request failed:', error);
                    throw error;
                }
            },
            login: (email) => api.request('/api/login', { method: 'POST', body: JSON.stringify({ email }) }),
            getScripts: (email) => api.request(`/api/scripts/${email}`),
            saveFile: (email, file_id, file_name) => api.request('/api/upload', { method: 'POST', body: JSON.stringify({ email, file_id, file_name }) }),
            runScript: (email, file_name) => api.request('/api/run', { method: 'POST', body: JSON.stringify({ email, file_name }) })
        };
        
        // --- CORE LOGIC ---

        const initializeApp = () => {
            const savedEmail = localStorage.getItem('userEmail');
            if (savedEmail) {
                state.email = savedEmail;
                showDashboard();
                fetchAndRenderScripts();
            } else {
                showLogin();
            }
        };

        const showLogin = () => {
            DOMElements.loginSection.style.display = 'block';
            DOMElements.dashboard.style.display = 'none';
            DOMElements.uploadSection.style.display = 'none';
        };

        const showDashboard = () => {
            DOMElements.loginSection.style.display = 'none';
            DOMElements.dashboard.style.display = 'block';
            DOMElements.uploadSection.style.display = 'block';
            initializeUploadWidget(); // Initialize uploader only after login
        };

        const fetchAndRenderScripts = async () => {
            if (!state.email) return;
            try {
                const scriptNames = await api.getScripts(state.email);
                renderScripts(scriptNames);
            } catch (error) {
                DOMElements.scriptsList.innerHTML = `<p class="text-yellow-400 text-center">Could not load scripts.</p>`;
            }
        };

        const renderScripts = (scriptNames) => {
            DOMElements.scriptsList.innerHTML = '';
            if (!scriptNames || scriptNames.length === 0) {
                DOMElements.scriptsList.innerHTML = '<p class="text-gray-500 text-center">No scripts saved. Upload one to get started!</p>';
                return;
            }
            scriptNames.forEach(name => {
                const scriptElement = document.createElement('div');
                scriptElement.className = 'bg-gray-800 p-4 rounded-lg flex items-center justify-between';
                scriptElement.innerHTML = `
                    <div>
                        <span class="font-mono text-white">${name}</span>
                    </div>
                    <div>
                        <button class="run-btn px-4 py-2 text-sm rounded transition-colors bg-green-600 hover:bg-green-700" data-filename="${name}">Run</button>
                    </div>
                `;
                DOMElements.scriptsList.appendChild(scriptElement);
            });
        };

        const initializeUploadWidget = () => {
            const widget = uploadcare.Widget('[role=uploadcare-uploader]');
            widget.onUploadComplete(async (fileInfo) => {
                try {
                    // This new system works best with single file uploads
                    const file_id = fileInfo.uuid;
                    const file_name = fileInfo.name;
                    await api.saveFile(state.email, file_id, file_name);
                    showNotification(`'${file_name}' saved successfully!`, 'success');
                    fetchAndRenderScripts(); // Refresh the list
                } catch (error) {
                    showNotification(`Failed to save file: ${error.message}`, 'error');
                }
            });
        };

        const showNotification = (message, type = 'success') => {
            const el = DOMElements.notification;
            el.textContent = message;
            el.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transform transition-all duration-300 ${type === 'error' ? 'bg-red-600' : 'bg-green-600'}`;
            el.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                el.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        };
        
        // --- EVENT HANDLERS ---

        DOMElements.loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = DOMElements.emailInput.value;
            if (!email) return;
            
            try {
                await api.login(email);
                state.email = email;
                localStorage.setItem('userEmail', email);
                showDashboard();
                fetchAndRenderScripts();
            } catch (error) {
                // Notification is shown by the api helper
            }
        });

        DOMElements.scriptsList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('run-btn')) {
                const button = e.target;
                const filename = button.dataset.filename;
                
                button.textContent = 'Starting...';
                button.disabled = true;

                try {
                    const result = await api.runScript(state.email, filename);
                    showNotification(result.message, 'success');
                } catch (error) {
                     // Notification is shown by the api helper
                } finally {
                    button.textContent = 'Run';
                    button.disabled = false;
                }
            }
        });
        
        // --- INITIALIZE THE APP ---
        initializeApp();
    });
            </script>
                    
</body>
</html>

